# 13장 더 심층적인 통찰력을 향한 리팩터링



## 심층적인 통찰력을 향한 리팩터링의 주요 요소

1. 활동의 근거지를 도메인으로 삼는다.
  - 리팩터링의 목적을 기술적인 코드 레벨에서 보다는 도메인에 대한 통찰에서 찾는다.
2. 현상과 사물을 다른 방식으로 바라보도록 노력한다.
  - 사물 본질에 집중하여 암시된 개념을 찾고 도메인에 대한 통찰력을 키운다.
3. 도메인 전문가와 지속적으로 대화한다.
  - 도메인 전문가와의 논의를 통해 도메인에 대한 이해를 심화한다.

### 1. 시작

**문제의 발견**

- 문제가 있는 위치를 발견하는 것은 가장 어려우면서도 모호한 과정이다. 
- 복잡성이나 부자연스러움과 같은 코드상에서 발견된 문제점을 해결하고자 리팩터링 시작
  - 어떤 개념이나 관계가 누락되거나 잘못 사용되었을 수 있다.
- 도메인 전문가가 이해하지 못하는 언어를 사용해서 모델이 작성되어 있거나 새로운 요구사항을 자연스럽게 수용할 수 없는 것을 발견한 경우일 수도 있다.

**새로운 모델 요소 찾기**

- 동료 및 전문가와 브레인스토밍
- 분석 패턴, 디자인 패턴 같은 체계적인 지식을 활용



### 2. 조사팀

**2.1 개선안 조사**

- 모델을 좀 더 명확하고 자연스럽게 의사소통할 수 있게 만들어줄 개선안 조사

**2.2 팀 꾸리기** : 4~5명

- 코드 변경에 착수한 개발자
- "해당 유형 문제에 대한 사고 능력", "도메인 영역에 대한 이해도", "모델링 기술이 뛰어남" 중의 스킬의 가진 개발자 두 명을 선별
- 난해한 부분이 있다면 도메인 전문가도 함께 참여  

**2.3 브레인스토밍**

- UML 다이어그램을 스케치
- 객체를 사용해서 시나리오 재현

**2.4 발견한 내용을 코드로 옮기기**



이 과정을 생산성 있게 진행하는 비결

- 자기 결정 : 즉시 규모가 작은 팀을 소집한다. 팀은 며칠 동안 작업을 진행한 후 해산한다. 장기간의 정교한 조직은 필요하지 않다.
- 범위와 휴식
  - 며칠에 걸쳐 두세 번 정도 짧은 회의 진행한 후, 시도할 가치가 있는 설계안 도출
  - 결정을 늦추는 것은 도움이 되지 않는다. 진행이 막혔다면 한번에 너무 많은 부분을 해결하려는 건 아닌지 돌아보라
- 유비쿼터스 언어의 사용
  - 도메인 전문가와 함께 리팩터링 과정을 진행하게 되는 것은 유비쿼터스 언어를 점검하고 개선할 수 있는 좋은 기회다.



## 선행 기술

- 항상 바퀴를 다시 만들 필요는 없다.
- 디자인 패턴, 분석 패턴, 도메인 자체에 관한 지식을 정리해놓은 자료에서도 아이디어를 얻을 수 있다.
  - 분석 패턴을 단순히 따라하기만 하면 안된다는 것에 주의
  - 분석 패턴은 지식 탐구 프로세스와 출발점을 제공하는 것



## 개발자를 위한 설계

- 소프트웨어는 사용자만을 위한 것이 아니다. 개발자를 위한 것이기도 하다.
- 유연한 설게는 설계의 의도를 전달한다.
  - 코드의 영향을 쉽게 예측
  - 설계 변경의 결과 역시 쉽게 예상
  - 의존성과 부수 효과를 감소시킴
  - 변경이 가장 빈번하게 발생하는 부분은 유연하게 유지하고, 자주 변경되지 않는 부분은 단순하게 만드는 데에 도움이 된다.



## 타이밍

- 변경을 완벽하게 정당화할 수 있을 때까지 기다린다면 지나치에 오랫동안 기다린 셈



#### 다음과 같은 경우 리팩터링을 수행한다.
 => 활동의 근거지를 도메인으로 삼는다.

- 도메인을 이해하고 있는 바가 설계에 표현돼 있지 않은 경우
- 중요한 개념이 설계상에 암시적으로 표현돼 있는 경우(개념을 명확하게 표현할 수 있는 방법이 보이는 경우)
  - 최근의 수익인증 첨부 예
- 설계상의 중요한 부분을 더욱 유연하게 만들 기회가 보이는 경우

```
- 도메인의 핵심을 찌르지 못하면서 단지 기술적인 기교를 뽐내기 위한 용도로 "유연한 설계"를 도입해서는 안된다.
- 도메인 전문가가 납득하지 못하는 "더 심층적인 모델"을 도입해서는 안 된다.
```



## 위기를 기회로

- 모델링을 일정 기간동안 꾸준히 정제하다 보면 어느 순간 갑자기 모든 것을 뒤흔드는 통찰력을 얻는다.
- 이런 상황은 종종 위기처럼 보일 수 있다. **숨겨져 있던 모델 내의 결점이 명백히 드러날 수 있다**.
- 이는 팀이 새로운 이해 수준에 도달했다는 의미다.
- 이를 기회로 삼아 암시적인 개념을 인식하여 명확하게 표현하고, 일부 설계는 유연하게 변경해 가야한다.

